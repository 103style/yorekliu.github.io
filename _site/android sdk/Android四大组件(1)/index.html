<!doctype html>
<!--
  Minimal Mistakes Jekyll Theme 4.8.0 by Michael Rose
  Copyright 2017 Michael Rose - mademistakes.com | @mmistakes
  Free for personal and commercial use under the MIT license
  https://github.com/mmistakes/minimal-mistakes/blob/master/LICENSE.txt
-->
<html lang="zh" class="no-js">
  <head>
    <meta charset="utf-8">

<!-- begin SEO -->









<title>            Android四大组件(1)      Yorek’s Blog      </title>




<meta name="description" content="Android四大组件分别是Activity、Service、ContentProvider以及BroadcastReceiver。">




<meta name="author" content="刘扬窑Yorek">

<meta property="og:locale" content="zh">
<meta property="og:site_name" content="Yorek's Blog">
<meta property="og:title" content="Android四大组件(1)">


  <link rel="canonical" href="http://localhost:4000/android%20sdk/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6(1)/">
  <meta property="og:url" content="http://localhost:4000/android%20sdk/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6(1)/">



  <meta property="og:description" content="Android四大组件分别是Activity、Service、ContentProvider以及BroadcastReceiver。">

















  

  





  <meta property="og:type" content="article">
  <meta property="article:published_time" content="2017-12-18T00:00:00+08:00">








  <script type="application/ld+json">
    {
      "@context" : "http://schema.org",
      "@type" : "Person",
      "name" : "刘扬窑",
      "url" : "http://localhost:4000",
      "sameAs" : null
    }
  </script>







<!-- end SEO -->


<link href="http://localhost:4000/feed.xml" type="application/atom+xml" rel="alternate" title="Yorek's Blog Feed">

<!-- http://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script>
  document.documentElement.className = document.documentElement.className.replace(/\bno-js\b/g, '') + ' js ';
</script>

<!-- For all browsers -->
<link rel="stylesheet" href="http://localhost:4000/assets/css/main.css">

<!--[if lte IE 9]>
  <style>
    /* old IE unsupported flexbox fixes */
    .greedy-nav .site-title {
      padding-right: 3em;
    }
    .greedy-nav button {
      position: absolute;
      top: 0;
      right: 0;
      height: 100%;
    }
  </style>
<![endif]-->


    <!-- start custom head snippets -->

<!-- insert favicons. use http://realfavicongenerator.net/ -->

<!-- end custom head snippets -->
  </head>

  <body class="layout--single">

    <!--[if lt IE 9]>
<div class="notice--danger align-center" style="margin: 0;">You are using an <strong>outdated</strong> browser. Please <a href="https://browsehappy.com/">upgrade your browser</a> to improve your experience.</div>
<![endif]-->

    <div class="masthead">
  <div class="masthead__inner-wrap">
    <div class="masthead__menu">
      <nav id="site-nav" class="greedy-nav">
        <a class="site-title" href="http://localhost:4000/">Yorek's Blog</a>
        <ul class="visible-links">
          
            
            <li class="masthead__menu-item">
              <a href="http://localhost:4000/categories/#android/" >Android</a>
            </li>
          
            
            <li class="masthead__menu-item">
              <a href="http://localhost:4000/categories/#android-sdk/" >工具相关</a>
            </li>
          
            
            <li class="masthead__menu-item">
              <a href="http://localhost:4000/categories/#machine-learning/" >Machine Learning</a>
            </li>
          
            
            <li class="masthead__menu-item">
              <a href="http://localhost:4000/year-archive/" >归档</a>
            </li>
          
        </ul>
        
        <button class="greedy-nav__toggle" type="button">
          <span class="visually-hidden">切换菜单</span>
          <div class="navicon"></div>
        </button>
        <ul class="hidden-links hidden"></ul>
      </nav>
    </div>
  </div>
</div>

    <div class="initial-content">
      



<div id="main" role="main">
  
  <div class="sidebar sticky">
  

<div itemscope itemtype="http://schema.org/Person">

  
    <div class="author__avatar">
      

      
        <img src="http://localhost:4000/assets/images/bio-photo.jpg" alt="刘扬窑Yorek" itemprop="image">
      
    </div>
  

  <div class="author__content">
    
      <h3 class="author__name" itemprop="name">刘扬窑Yorek</h3>
    
    
      <p class="author__bio" itemprop="description">
        An Android Developer.
      </p>
    
  </div>

  <div class="author__urls-wrapper">
    <button class="btn btn--inverse">关注</button>
    <ul class="author__urls social-icons">
      
        <li itemprop="homeLocation" itemscope itemtype="http://schema.org/Place">
          <i class="fa fa-fw fa-map-marker" aria-hidden="true"></i> <span itemprop="name">Shanghai, China.</span>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      
        <li>
          <a href="https://github.com/YorekLiu" itemprop="sameAs">
            <i class="fa fa-fw fa-github" aria-hidden="true"></i> GitHub
          </a>
        </li>
      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <!--
  <li>
    <a href="http://link-to-whatever-social-network.com/user/" itemprop="sameAs">
      <i class="fa fa-fw" aria-hidden="true"></i> Custom Social Profile Link
    </a>
  </li>
-->
    </ul>
  </div>
</div>

  
  </div>


  <article class="page" itemscope itemtype="http://schema.org/CreativeWork">
    <meta itemprop="headline" content="Android四大组件(1)">
    <meta itemprop="description" content="Android四大组件分别是Activity、Service、ContentProvider以及BroadcastReceiver。">
    <meta itemprop="datePublished" content="December 18, 2017">
    

    <div class="page__inner-wrap">
      
        <header>
          <h1 class="page__title" itemprop="headline">Android四大组件(1)
</h1>
          
            <p class="page__meta"><i class="fa fa-clock-o" aria-hidden="true"></i> 




  3 分钟读完
</p>
          
        </header>
      

      <section class="page__content" itemprop="text">
        
        <p>Android四大组件分别是Activity、Service、ContentProvider以及BroadcastReceiver。</p>

<p>其中，Activity是使用最频繁的一个组件，可以翻译为界面。当然，我们常见的界面除了Activity，还有Window(这里指悬浮窗，类似于360的悬浮球)、Dialog以及Toast。Android中所有的视图都是通过Window来呈现的。</p>

<p>关于Fragment，可以查看<a href="http://www.jianshu.com/p/41696ae40906">Android四大组件(4)</a>。两者一起看能更好的了解彼此。</p>

<p>本章的主要内容有：Activity生命周期、启动模式、IntentFilter匹配规则。</p>

<p>英语好的可以直接看<a href="https://developer.android.com/reference/android/app/Activity.html">google官方文档</a>，讲的更多更细。</p>

<h2 id="1-activity的生命周期">1 Activity的生命周期</h2>
<p>Activity的生命周期分为两个部分：正常情况、异常情况。
所谓正常情况就是指在用户的参与下经历的生命周期的改变；而异常情况是指Activity因RAM不足被LMK杀死或者由于的Configuration(比如横竖屏切换、语言改变等)改变导致Activity销毁重构。</p>

<h3 id="11-正常情况下activity的生命周期">1.1 正常情况下Activity的生命周期</h3>
<p>如图，是正常情况下Activity所经历的生命周期。
<img src="http://upload-images.jianshu.io/upload_images/2525608-aff866a076421fe2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="activity_lifecycle" /></p>

<ol>
  <li>onCreate：当Activity第一次创建的时候调用。在这里，我们做一些初始化工作：加载布局、初始化Activity所需要的数据等。</li>
  <li>onRestart：Activity重新启动。当Activity从不可见重新变成可见状态时，此方法会被调用。</li>
  <li>onStart：表示Activity正在启动，当Activity正在变成可见状态时会被调用。</li>
  <li>onResume：表示Activity已经可见了，且出现在前台可与用户进行交互。</li>
  <li>onPause：Activity正在停止。此时可以提交未保存的数据、停止动画或其他可能消耗CPU资源的操作。在此方法中不能执行耗时操作，因为下一个Activity不会调用onResume直到该方法执行完。</li>
  <li>onStop：Activity即将停止，当Activity不在可见时调用，因为另一个Activity已经调用了onResume，并且覆盖了这个Activity。</li>
  <li>onDestroy：Activity即将被销毁。</li>
</ol>

<p>在Activity的生命周期中有三个关键的循环：</p>
<ul>
  <li>完整生命周期：第一次调用onCreate ~ 最终调用onDestory
我们可以在onCreate中初始化所有数据，在onDestroy中释放。比如后台下载数据的线程。</li>
  <li>可见生命周期：onStart ~ onStop
在此期间，用户可以看到Activity在屏幕上，但是并不在前台，因此也不能与用户进行交互。在着两个方法里可以维护需要展示给用户的资源。比如在onStart里面注册BroadcastReceiver，在onStop里面unregister。onStart、onStop会根据Activity对用户的显示、隐藏可以调用多次。</li>
  <li>前台生命周期：onResume ~ onPause
在此期间，Activity在所有其他activity的上面，可以与用户进行交互。
一个activity可以频繁的经历resumed和paused状态，比如设备休眠，activity的结果返回了，接收到了新的intent等等。因此，在这两个方法里面的代码应该要非常轻量。</li>
</ul>

<p><strong>如果Activity A启动B，那么A和B的生命周期的生命周期调用顺序怎么样呢？</strong></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">D</span><span class="o">/</span><span class="nl">A:</span> <span class="n">onPause</span><span class="o">()</span> <span class="n">called</span>
<span class="n">D</span><span class="o">/</span><span class="nl">B:</span> <span class="n">onCreate</span><span class="o">()</span> <span class="n">called</span> <span class="nl">with:</span> <span class="n">savedInstanceState</span> <span class="o">=</span> <span class="o">[</span><span class="kc">null</span><span class="o">]</span>
<span class="n">D</span><span class="o">/</span><span class="nl">B:</span> <span class="n">onStart</span><span class="o">()</span> <span class="n">called</span>
<span class="n">D</span><span class="o">/</span><span class="nl">B:</span> <span class="n">onResume</span><span class="o">()</span> <span class="n">called</span>
<span class="n">D</span><span class="o">/</span><span class="nl">A:</span> <span class="n">onStop</span><span class="o">()</span> <span class="n">called</span>
</code></pre></div></div>
<p>很显然，Android系统只允许一个Activity出现在前台，因此会先执行A的onPause方法使A退出前台，然后在执行B启动过程使其出现在前台，最后在调用A的onStop方法。</p>

<h3 id="12-异常情况下activity的生命周期">1.2 异常情况下Activity的生命周期</h3>
<h4 id="121-资源发生了改变">1.2.1 资源发生了改变</h4>
<p>在默认情况下，系统配置改变将会导致当前的activity被销毁，该activity会经历正常的生命周期方法，onPause、onStop、onDestroy会被调用。如果此activity在前台或者用户可见，此activity会在onDestroy调用后被重新创建。
由于activity是异常终止的，所以系统会调用onSaveInstanceState(Bundle)保存当前activity的状态，当activity被重新创建后，会调用onRestoreInstanceState；此外重构时Bundle也会传入onCreate方法中。
<strong><code class="highlighter-rouge">onSaveInstanceState</code>将会调用在<code class="highlighter-rouge">onStop</code>之前，与onPause没有时序关系。<code class="highlighter-rouge">onRestoreInstanceState</code>在<code class="highlighter-rouge">onStart</code>与<code class="highlighter-rouge">onPostCreate</code>之间被调用。<code class="highlighter-rouge">onPostCreate</code>在<code class="highlighter-rouge">onResume</code>之前调用。</strong>
另外，在资源改变导致重新创建时，系统自动为我们做了一些恢复工作。具体某个特定的View能够为我们恢复哪些数据，可以查看View的这两个方法。</p>

<p><strong>上面我们提到，在默认情况下，系统配置改变将会导致当前的activity被销毁重建，那怎么阻止该过程的发生呢？</strong>
我们可以通过配置activity的configChanges属性达到目的。比如我们不想屏幕旋转时重新创建，可以在activity添加configChanges=”orientation”，如果我们想指定多个值，可以通过或操作”|”连接起来，比如”mcc|mnc”
<a href="https://developer.android.com/reference/android/R.attr.html#configChanges">所有的config以及解释，需要翻墙</a></p>

<p><strong>横竖屏切换生命周期？</strong>
网上流传的横屏切换回竖屏生命周期执行两次，我看到了就觉得比较可疑。然后自己试验了下，也找了资料。现在完全不是这么回事了。</p>
<ol>
  <li>只设置configChanges=”orientation”和不设置这个属性，Activity都会销毁重建</li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>设置configChanges=”orientation</td>
          <td>keyboardHidden”，在Android 2.3上不会重建，超过会重建</td>
        </tr>
      </tbody>
    </table>
  </li>
  <li>
    <table>
      <tbody>
        <tr>
          <td>设置configChanges=”orientation</td>
          <td>screenSize”时，在Android 4.0以上不会重建</td>
        </tr>
      </tbody>
    </table>
  </li>
</ol>

<h4 id="122-内存不足导致低优先级的activity被杀死">1.2.2 内存不足导致低优先级的activity被杀死</h4>
<p>这种情况下activity的数据存储、恢复的过程和1完全一样。当系统资源不足时，系统会按照activity的优先级顺序来杀死目标Activity所在的进程。Activity的优先级从高到低，可以分来三中：</p>
<ol>
  <li>前台Activity —— 正在和用户进行交互，处于running状态</li>
  <li>可见但非前台 —— 比如Activity弹出了一个对话框</li>
  <li>后台Activity —— 已经执行了onStop
  因此，后台工作不适合脱离四大组件而独自运行，这样容易被杀死。比较好的方式是将后台任务放入Service中，这样能保证进程有一定的优先级。</li>
</ol>

<h2 id="2-activity的启动模式">2 Activity的启动模式</h2>
<p>本节的主要内容有：Activity的LaunchMode以及Flags</p>

<h3 id="21-launchmode">2.1 LaunchMode</h3>
<p>目前有四种启动模式：standard、singleTop、singleTask、singleInstance</p>
<ul>
  <li>standard
默认的启动模式。每次启动activity都会创建一个新的实例，不管该实例是否已经存在。被启动的activity会运行在启动该activity的任务栈中。所以使用非Activity类型的Context启动一个standard Activity就会报错，解决该问题的办法是为待启动的Activity指定FLAG_ACTIVITY_NEW_TASK，这样启动的时候就会为它准备一个新的任务栈，这样待启动Activity实际上是以singleTask模式启动的。</li>
  <li>singleTop
栈顶复用模式。如果Activity已经位于任务栈的栈顶，那么Activity不会重新创建，同时其onNewIntent方法会被回调。</li>
  <li>singleTask
栈内复用模式。这是一种单实例模式，只要Activity在一个栈中存在，多起启动该Activity都不会重新创建实例，和singleTop一样，系统会回调其onNewIntent方法。同时，位于该Activity上面的Activity都会被出栈，所以该启动模式具有FLAG_ACTIVITY_CLEAR_TOP效果。</li>
  <li>singleInstance
单实例模式。加强版的singleTask，它具有singleTask的一些特点，此外，还强调了一点：具有该模式的Activity只能单独的位于一个任务栈中。</li>
</ul>

<h3 id="22-任务栈">2.2 任务栈</h3>
<p>任务栈分为前台任务栈和后台任务栈，后台任务栈中的activity处于暂停状态，用户可以通过操作将后台任务栈再次调回前台。
可以使用<code class="highlighter-rouge">adb shell dumpsys activity</code>查看任务栈信息，信息在<code class="highlighter-rouge">Running activities (most recent first)</code>这一栏中。
在activity中有一个属性可以标记该activity运行在哪个任务栈中，这个属性就是android:taskAffinity。taskAffinity必须为字符串，且中间必须含有包名分隔符”.”。默认情况下，activity运行在应用包名的任务栈中。该属性主要用在singleTask启动模式或者与allowTaskReparenting属性配对使用。
taskAffinity与singleTask连用比较好理解，而与allowTaskReparenting连用有点麻烦。allowTaskReparenting属性的意思是，当下次进入前台时，是否允许此Activity从启动它的task移动到与affinity一样的task。假设有两个应用A和B，应用A中的Activity启动了应用B中带有allowTaskReparenting属性的Activity 1，然后按HOME键回到桌面，进入B应用，会发现出现的是Activity 1，而不是应用B的主Activity。</p>

<h3 id="23-activity的启动方式">2.3 Activity的启动方式</h3>
<p>Activity的启动方式有两种</p>
<ul>
  <li>通过指定activity节点的launchMode属性</li>
  <li>通过startActivity中Intent的addFlags方法添加标志位
两种方式的区别：
    <ol>
      <li>后者优先级会高于前者，即两种方式同时存在时，以后者为准</li>
      <li>两种方式可使用范围不同，比如前者无法给Activity设置FLAG_ACTIVITY_CLEAR_TOP标识，后者无法为Activity指定singleInstance模式。</li>
    </ol>
  </li>
</ul>

<h3 id="24-activity的flags">2.4 Activity的Flags</h3>
<p>Activity中有些Flags可以影响Activity的启动模式，有些则可以影响Activity的运行状态。下面主要说说常见的几个标记位。</p>

<table>
  <thead>
    <tr>
      <th style="text-align: left">Flags</th>
      <th style="text-align: left">意义</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td style="text-align: left">FLAG_ACTIVITY_NEW_TASK</td>
      <td style="text-align: left">为Activity指定”singleTask”启动模式</td>
    </tr>
    <tr>
      <td style="text-align: left">FLAG_ACTIVITY_SINGLE_TOP</td>
      <td style="text-align: left">为Activity指定”singleTop”启动模式</td>
    </tr>
    <tr>
      <td style="text-align: left">FLAG_ACTIVITY_CLEAR_TOP</td>
      <td style="text-align: left">启动此Activity时，同一任务栈中所有位于它上面的Activity都会出栈。此Activity会调用onNewIntent还是重新创建与其自身启动模式有关。如果此Activity启动模式是standard，则会finish然后re-created；如果是其他的启动模式，则会调用当前实例的onNewIntent方法。与FLAG_ACTIVITY_NEW_TASK连用会使目标Activity出现在栈顶，这在有些时候是非常好用的，比如从通知栏运行Activity。</td>
    </tr>
    <tr>
      <td style="text-align: left">FLAG_ACTIVITY_EXCLUDE_FROM_RECENTS</td>
      <td style="text-align: left">包含有此标记的Activity不会出现在历史Activity中，也可以使用android:excludeFromRecents=”true”属性</td>
    </tr>
  </tbody>
</table>

<h2 id="3-intentfilter的匹配规则">3 IntentFilter的匹配规则</h2>
<p>intent-filter在AndroidManifest.xml中的写法</p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;intent-filter&gt;</span>
    <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">"android.intent.action.VIEW"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">"android.intent.action.EDIT"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;action</span> <span class="na">android:name=</span><span class="s">"android.intent.action.PICK"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;category</span> <span class="na">android:name=</span><span class="s">"android.intent.category.DEFAULT"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;data</span> <span class="na">android:mimeType=</span><span class="s">"vnd.android.cursor.dir/vnd.google.note"</span> <span class="nt">/&gt;</span>
<span class="nt">&lt;/intent-filter&gt;</span>
</code></pre></div></div>
<p>IntentFilter用在Activity的隐式调用上。IntentFilter中的过滤信息主要有action、category以及data。
只有一个Intent完全匹配上了action、category、data，才算匹配成功。一个Activity可以有多个intent-filter，只要一个Intent匹配成功了任何一组intent-filter就算成功匹配。
IntentFilter的匹配规则代码如下：</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1">// frameworks/base/core/java/android/content/IntentFilter.java</span>
<span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">match</span><span class="o">(</span><span class="n">String</span> <span class="n">action</span><span class="o">,</span> <span class="n">String</span> <span class="n">type</span><span class="o">,</span> <span class="n">String</span> <span class="n">scheme</span><span class="o">,</span>
            <span class="n">Uri</span> <span class="n">data</span><span class="o">,</span> <span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">categories</span><span class="o">,</span> <span class="n">String</span> <span class="n">logTag</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">action</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">matchAction</span><span class="o">(</span><span class="n">action</span><span class="o">))</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">NO_MATCH_ACTION</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="kt">int</span> <span class="n">dataMatch</span> <span class="o">=</span> <span class="n">matchData</span><span class="o">(</span><span class="n">type</span><span class="o">,</span> <span class="n">scheme</span><span class="o">,</span> <span class="n">data</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">dataMatch</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">dataMatch</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="n">String</span> <span class="n">categoryMismatch</span> <span class="o">=</span> <span class="n">matchCategories</span><span class="o">(</span><span class="n">categories</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">categoryMismatch</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">NO_MATCH_CATEGORY</span><span class="o">;</span>
        <span class="o">}</span>
        <span class="k">return</span> <span class="n">dataMatch</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div></div>
<h3 id="31-action的匹配规则">3.1 action的匹配规则</h3>
<p>action的匹配规则是指Intent中的action必须和intent-filter中的action匹配。一个过滤规则中可以有多个action，只要Intent中的action能够和intent-filter中任何一个action相同即可匹配成功。因此，Intent中如果没有指定action，那么匹配失败。
<strong>action的匹配规则要求Intent中的action必须存在且必须和过滤规则中某个action相同</strong></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">private</span> <span class="kd">final</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">mActions</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">matchAction</span><span class="o">(</span><span class="n">String</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="nf">hasAction</span><span class="o">(</span><span class="n">action</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">boolean</span> <span class="nf">hasAction</span><span class="o">(</span><span class="n">String</span> <span class="n">action</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">action</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">mActions</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">action</span><span class="o">);</span>
    <span class="o">}</span>
</code></pre></div></div>

<h3 id="32-category的匹配规则">3.2 category的匹配规则</h3>
<p><strong>category的匹配规则要求Intent中如果含有category，那么Intent中所有的category都必须和过滤规则中的某个category相同。</strong>
如果没有添加category，系统在startActivity或者startActivityForResult时会默认加上”android.intent.category.DEFAULT”这个category，所以为了我们的Activity可以接受隐式调用，需要在intent-filter中指定”android.intent.category.DEFAULT”这个category。</p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">private</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">mCategories</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>

    <span class="kd">public</span> <span class="kd">final</span> <span class="n">String</span> <span class="nf">matchCategories</span><span class="o">(</span><span class="n">Set</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">categories</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">categories</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="n">Iterator</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">it</span> <span class="o">=</span> <span class="n">categories</span><span class="o">.</span><span class="na">iterator</span><span class="o">();</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">mCategories</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="n">it</span><span class="o">.</span><span class="na">hasNext</span><span class="o">()</span> <span class="o">?</span> <span class="n">it</span><span class="o">.</span><span class="na">next</span><span class="o">()</span> <span class="o">:</span> <span class="kc">null</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="k">while</span> <span class="o">(</span><span class="n">it</span><span class="o">.</span><span class="na">hasNext</span><span class="o">())</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="n">String</span> <span class="n">category</span> <span class="o">=</span> <span class="n">it</span><span class="o">.</span><span class="na">next</span><span class="o">();</span>
            <span class="k">if</span> <span class="o">(!</span><span class="n">mCategories</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">category</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">category</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div></div>

<h3 id="33-data的匹配规则">3.3 <a href="https://developer.android.com/guide/topics/manifest/data-element.html">data的匹配规则</a></h3>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;data</span> <span class="na">android:scheme=</span><span class="s">"string"</span>
      <span class="na">android:host=</span><span class="s">"string"</span>
      <span class="na">android:port=</span><span class="s">"string"</span>
      <span class="na">android:path=</span><span class="s">"string"</span>
      <span class="na">android:pathPattern=</span><span class="s">"string"</span>
      <span class="na">android:pathPrefix=</span><span class="s">"string"</span>
      <span class="na">android:mimeType=</span><span class="s">"string"</span> <span class="nt">/&gt;</span>
</code></pre></div></div>
<p>data结构有点复杂。先说一下data的结构：data由mimeType和URI两部分组成。
mimeType指媒体类型，比如image/jpeg、image/png、audio/mpeg4-generic和video/*等。mimeType在Android framework的匹配是大小写敏感的，所以mimeType应该要使用小写字母。
而URI包含的数据由很多部分组成:
<code class="highlighter-rouge">&lt;scheme&gt;://&lt;host&gt;:&lt;port&gt;[&lt;path&gt;|&lt;pathPrefix&gt;|&lt;pathPattern&gt;]</code></p>
<ul>
  <li>scheme：URI的模式，比如http、file、content等。缺少该部分，整个URI无效。</li>
  <li>host：URI的主机名。缺少该部分，整个URI无效。</li>
  <li>port：端口号，仅当URI中指定了scheme和host时，port才是有意义的。</li>
  <li>path、pathPrefix、pathPattern：路径信息，必须以”/”开头。path表示完整信息；pathPattern也表示完成信息，但是它可以包含通配符”<em>“，”</em>“表示0或多个前一个字符，”.<em>“表示匹配0或者多个任意字符。注意，由于正则表达式的规范，”</em>“要被转义成”*“；pathPrefix表示路径的前缀信息。</li>
</ul>

<p>过滤规则中如果没有写URI，则有一个默认值：content:和file:。即Intent中的URI的scheme部分必须是content或者file才能匹配。
此外，如果Intent要指定完整的data，必须使用<code class="highlighter-rouge">setDataAndType</code>方法，而不能调用<code class="highlighter-rouge">setData</code>和<code class="highlighter-rouge">setType</code>，着两个方法会清除对方的值。
在同一个<intent-filter>节点下所有的<data>标签都作用与同一个filter，因此下面两种写法是等价的：</data></intent-filter></p>
<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;intent-filter</span> <span class="err">.</span> <span class="err">.</span> <span class="err">.</span> <span class="nt">&gt;</span>
    <span class="nt">&lt;data</span> <span class="na">android:scheme=</span><span class="s">"something"</span> <span class="na">android:host=</span><span class="s">"project.example.com"</span> <span class="nt">/&gt;</span>
    . . .
<span class="nt">&lt;/intent-filter&gt;</span>

<span class="nt">&lt;intent-filter</span> <span class="err">.</span> <span class="err">.</span> <span class="err">.</span> <span class="nt">&gt;</span>
    <span class="nt">&lt;data</span> <span class="na">android:scheme=</span><span class="s">"something"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;data</span> <span class="na">android:host=</span><span class="s">"project.example.com"</span> <span class="nt">/&gt;</span>
    . . .
<span class="nt">&lt;/intent-filter&gt;</span>
</code></pre></div></div>
<p>data的匹配规则和action类似，<strong>它要求Intent中必须含有data数据，并且data数据能够完全匹配过滤规则中的某个data。</strong></p>
<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="kd">public</span> <span class="kd">final</span> <span class="kt">int</span> <span class="nf">matchData</span><span class="o">(</span><span class="n">String</span> <span class="n">type</span><span class="o">,</span> <span class="n">String</span> <span class="n">scheme</span><span class="o">,</span> <span class="n">Uri</span> <span class="n">data</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">final</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">types</span> <span class="o">=</span> <span class="n">mDataTypes</span><span class="o">;</span>
        <span class="kd">final</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">schemes</span> <span class="o">=</span> <span class="n">mDataSchemes</span><span class="o">;</span>

        <span class="kt">int</span> <span class="n">match</span> <span class="o">=</span> <span class="n">MATCH_CATEGORY_EMPTY</span><span class="o">;</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">types</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">schemes</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">return</span> <span class="o">((</span><span class="n">type</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">data</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span>
                <span class="o">?</span> <span class="o">(</span><span class="n">MATCH_CATEGORY_EMPTY</span><span class="o">+</span><span class="n">MATCH_ADJUSTMENT_NORMAL</span><span class="o">)</span> <span class="o">:</span> <span class="n">NO_MATCH_DATA</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">schemes</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">schemes</span><span class="o">.</span><span class="na">contains</span><span class="o">(</span><span class="n">scheme</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">?</span> <span class="n">scheme</span> <span class="o">:</span> <span class="s">""</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">MATCH_CATEGORY_SCHEME</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">NO_MATCH_DATA</span><span class="o">;</span>
            <span class="o">}</span>

            <span class="kd">final</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PatternMatcher</span><span class="o">&gt;</span> <span class="n">schemeSpecificParts</span> <span class="o">=</span> <span class="n">mDataSchemeSpecificParts</span><span class="o">;</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">schemeSpecificParts</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">data</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">hasDataSchemeSpecificPart</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">getSchemeSpecificPart</span><span class="o">())</span>
                        <span class="o">?</span> <span class="n">MATCH_CATEGORY_SCHEME_SPECIFIC_PART</span> <span class="o">:</span> <span class="n">NO_MATCH_DATA</span><span class="o">;</span>
            <span class="o">}</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">match</span> <span class="o">!=</span> <span class="n">MATCH_CATEGORY_SCHEME_SPECIFIC_PART</span><span class="o">)</span> <span class="o">{</span>
                <span class="c1">// If there isn't any matching ssp, we need to match an authority.</span>
                <span class="kd">final</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">AuthorityEntry</span><span class="o">&gt;</span> <span class="n">authorities</span> <span class="o">=</span> <span class="n">mDataAuthorities</span><span class="o">;</span>
                <span class="k">if</span> <span class="o">(</span><span class="n">authorities</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                    <span class="kt">int</span> <span class="n">authMatch</span> <span class="o">=</span> <span class="n">matchDataAuthority</span><span class="o">(</span><span class="n">data</span><span class="o">);</span>
                    <span class="k">if</span> <span class="o">(</span><span class="n">authMatch</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
                        <span class="kd">final</span> <span class="n">ArrayList</span><span class="o">&lt;</span><span class="n">PatternMatcher</span><span class="o">&gt;</span> <span class="n">paths</span> <span class="o">=</span> <span class="n">mDataPaths</span><span class="o">;</span>
                        <span class="k">if</span> <span class="o">(</span><span class="n">paths</span> <span class="o">==</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                            <span class="n">match</span> <span class="o">=</span> <span class="n">authMatch</span><span class="o">;</span>
                        <span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">hasDataPath</span><span class="o">(</span><span class="n">data</span><span class="o">.</span><span class="na">getPath</span><span class="o">()))</span> <span class="o">{</span>
                            <span class="n">match</span> <span class="o">=</span> <span class="n">MATCH_CATEGORY_PATH</span><span class="o">;</span>
                        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                            <span class="k">return</span> <span class="n">NO_MATCH_DATA</span><span class="o">;</span>
                        <span class="o">}</span>
                    <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                        <span class="k">return</span> <span class="n">NO_MATCH_DATA</span><span class="o">;</span>
                    <span class="o">}</span>
                <span class="o">}</span>
            <span class="o">}</span>
            <span class="c1">// If neither an ssp nor an authority matched, we're done.</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">match</span> <span class="o">==</span> <span class="n">NO_MATCH_DATA</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">NO_MATCH_DATA</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// Special case: match either an Intent with no data URI,</span>
            <span class="c1">// or with a scheme: URI.  This is to give a convenience for</span>
            <span class="c1">// the common case where you want to deal with data in a</span>
            <span class="c1">// content provider, which is done by type, and we don't want</span>
            <span class="c1">// to force everyone to say they handle content: or file: URIs.</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">scheme</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="s">""</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">scheme</span><span class="o">)</span>
                    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="s">"content"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">scheme</span><span class="o">)</span>
                    <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="s">"file"</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">scheme</span><span class="o">))</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">NO_MATCH_DATA</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">if</span> <span class="o">(</span><span class="n">types</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">findMimeType</span><span class="o">(</span><span class="n">type</span><span class="o">))</span> <span class="o">{</span>
                <span class="n">match</span> <span class="o">=</span> <span class="n">MATCH_CATEGORY_TYPE</span><span class="o">;</span>
            <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">NO_MATCH_TYPE</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="c1">// If no MIME types are specified, then we will only match against</span>
            <span class="c1">// an Intent that does not have a MIME type.</span>
            <span class="k">if</span> <span class="o">(</span><span class="n">type</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">return</span> <span class="n">NO_MATCH_TYPE</span><span class="o">;</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">return</span> <span class="n">match</span> <span class="o">+</span> <span class="n">MATCH_ADJUSTMENT_NORMAL</span><span class="o">;</span>
    <span class="o">}</span>
</code></pre></div></div>

<p>最后，通过隐式启动Activity时，如果没有Activity能够匹配我们的隐式Intent，我们startActivity就会报错。
我们有两种方法解决：</p>
<ol>
  <li>可以使用PackageManager或者Intent的<code class="highlighter-rouge">resolveActivity</code>方法，如果没有匹配的Activity则会返回null。（Intent的该方法是基于PackageManager的同名方法的。）</li>
  <li>可以使用PackageManager的<code class="highlighter-rouge">queryIntentActivities</code>方法，该方法会返回所有成功匹配的Activity信息，而不是resolveActivity的最佳匹配。
  注意下PackageManager的第二个参数，这里要传入MATCH_DEFAULT_ONLY这个参数，这个参数的意义在于匹配声明了”android.intent.category.DEFAULT”的Activity，不然匹配上的Activity不一定可以成功启动。
    <div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="c1">// PackageManager</span>
 <span class="kd">public</span> <span class="kd">abstract</span> <span class="n">ResolveInfo</span> <span class="nf">resolveActivity</span><span class="o">(</span><span class="n">Intent</span> <span class="n">intent</span><span class="o">,</span> 
         <span class="nd">@ResolveInfoFlags</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">);</span>
 <span class="kd">public</span> <span class="kd">abstract</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">ResolveInfo</span><span class="o">&gt;</span> <span class="nf">queryIntentActivities</span><span class="o">(</span><span class="n">Intent</span> <span class="n">intent</span><span class="o">,</span>
         <span class="nd">@ResolveInfoFlags</span> <span class="kt">int</span> <span class="n">flags</span><span class="o">);</span>

 <span class="c1">// Intent</span>
 <span class="kd">public</span> <span class="n">ComponentName</span> <span class="nf">resolveActivity</span><span class="o">(</span><span class="n">PackageManager</span> <span class="n">pm</span><span class="o">)</span> <span class="o">{</span>
     <span class="k">if</span> <span class="o">(</span><span class="n">mComponent</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">return</span> <span class="n">mComponent</span><span class="o">;</span>
     <span class="o">}</span>

     <span class="n">ResolveInfo</span> <span class="n">info</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="na">resolveActivity</span><span class="o">(</span>
         <span class="k">this</span><span class="o">,</span> <span class="n">PackageManager</span><span class="o">.</span><span class="na">MATCH_DEFAULT_ONLY</span><span class="o">);</span>
     <span class="k">if</span> <span class="o">(</span><span class="n">info</span> <span class="o">!=</span> <span class="kc">null</span><span class="o">)</span> <span class="o">{</span>
         <span class="k">return</span> <span class="k">new</span> <span class="nf">ComponentName</span><span class="o">(</span>
                 <span class="n">info</span><span class="o">.</span><span class="na">activityInfo</span><span class="o">.</span><span class="na">applicationInfo</span><span class="o">.</span><span class="na">packageName</span><span class="o">,</span>
                 <span class="n">info</span><span class="o">.</span><span class="na">activityInfo</span><span class="o">.</span><span class="na">name</span><span class="o">);</span>
     <span class="o">}</span>

     <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
 <span class="o">}</span>
</code></pre></div>    </div>
  </li>
</ol>

        
      </section>

      <footer class="page__meta">
        
        
  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fa fa-fw fa-tags" aria-hidden="true"></i> 标签: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="http://localhost:4000/tags/#activity" class="page__taxonomy-item" rel="tag">Activity</a>
    
    </span>
  </p>




  


  
  
  

  <p class="page__taxonomy">
    <strong><i class="fa fa-fw fa-folder-open" aria-hidden="true"></i> 分类: </strong>
    <span itemprop="keywords">
    
      
      
      <a href="http://localhost:4000/categories/#android-sdk" class="page__taxonomy-item" rel="tag">Android SDK</a>
    
    </span>
  </p>


        
          <p class="page__date"><strong><i class="fa fa-fw fa-calendar" aria-hidden="true"></i> 更新时间:</strong> <time datetime="2017-12-18T00:00:00+08:00">December 18, 2017</time></p>
        
      </footer>

      

      
    </div>

    
  </article>

  
  
    <div class="page__related">
      <h4 class="page__related-title">猜您还喜欢</h4>
      <div class="grid__wrapper">
        
          



<div class="grid__item">
  <article class="archive__item" itemscope itemtype="http://schema.org/CreativeWork">
    
    <h2 class="archive__item-title" itemprop="headline">
      
        <a href="http://localhost:4000/android%20sdk/Android%E5%9B%9B%E5%A4%A7%E7%BB%84%E4%BB%B6(1)/" rel="permalink">Android四大组件(1)
</a>
      
    </h2>
    
      <p class="page__meta"><i class="fa fa-clock-o" aria-hidden="true"></i> 




  3 分钟读完
</p>
    
    <p class="archive__item-excerpt" itemprop="description">Android四大组件分别是Activity、Service、ContentProvider以及BroadcastReceiver。

</p>
  </article>
</div>
        
      </div>
    </div>
  
</div>

    </div>

    

    <div class="page__footer">
      <footer>
        <!-- start custom footer snippets -->

<!-- end custom footer snippets -->
        <div class="page__footer-follow">
  <ul class="social-icons">
    
      <li><strong>关注:</strong></li>
    
    
    
    
      <li><a href="https://github.com/YorekLiu"><i class="fa fa-fw fa-github" aria-hidden="true"></i> GitHub</a></li>
    
    
    
    <li><a href="http://localhost:4000/feed.xml"><i class="fa fa-fw fa-rss-square" aria-hidden="true"></i> Feed</a></li>
  </ul>
</div>

<div class="page__footer-copyright">&copy; 2017 刘扬窑. 技术来自于 <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> &amp; <a href="https://mademistakes.com/work/minimal-mistakes-jekyll-theme/" rel="nofollow">Minimal Mistakes</a>.</div>

      </footer>
    </div>

    
  <script src="http://localhost:4000/assets/js/main.min.js"></script>








  </body>
</html>