---
title: "JNI与NDK编程简介"
excerpt: "本章介绍一下JNI与NDK编程中Hello World级别的实现"
categories:
  - Android
tags:
  - JNI
  - NDK
  - native
  - cmake
comments: true
toc: true
toc_label: "目录"
toc_icon: "heart"
last_modified_at: 2018-01-19T23:36:02+08:00
---

## 1 JNI与NDK简介
JNI指Java Native Interface，它可以使Java调用C/C++代码。

NDK是Android提供的一个工具集合，通过NDK可以在Android中更加方便的通过JNI来访问本地代码。NDK还提供了交叉编译器，开发人员只需要简单的修改mk文件就可以生成特定CPU平台的动态库。NDK的好处有如下几点：
1. **提高代码安全性**。由于so库反编译比较困难，因此NDK提高了Android程序的安全性。
2. **可以很方便的使用目前已拥有的C/C++开源库。**
3. **便于平台间的移植。**通过C/C++实现的动态库可以很方便的在其他平台上使用。**
4. **提高程序在某些特定情况下的执行效率**，但不能明显提升Android程序的性能。

## 2 JNI的开发流程
JNI的开发流程有如下几步：
1. 在Java中声明native方法
2. 编译Java源文件得到class文件，然后通过javah命令导出JNI的头文件
3. 实现JNI方法
4. 编译so库并在Java中调用

### 2.1 在Java中声明native方法

创建一个类，声明两个native方法:get和set(String)。
```java
package com.example;

import java.lang.System;

public class JniTest {

  public static void main(String[] args) {
    JniTest jniTest = new JniTest();
    System.out.println(jniTest.get());
    jniTest.set("hello world");
  }

  public native String get();
  public native String set(String str);
}
```

### 2.2 编译Java源文件得到class文件，然后通过javah命令导出JNI的头文件

```
javac com/example/JniTest.java
javah com.example.JniTest
```
![jni编译Java源文件]({{ basepath }}/assets/images/jni编译Java源文件.png)

输入上面命令后会在当前目录生成`com_example_JniTest.h`文件，它是javah命令生成的。内容如下所示：
```c++
/* DO NOT EDIT THIS FILE - it is machine generated */
#include <jni.h>
/* Header for class com_example_JniTest */

#ifndef _Included_com_example_JniTest
#define _Included_com_example_JniTest
#ifdef __cplusplus
extern "C" {
#endif
/*
 * Class:     com_example_JniTest
 * Method:    get
 * Signature: ()Ljava/lang/String;
 */
JNIEXPORT jstring JNICALL Java_com_example_JniTest_get
  (JNIEnv *, jobject);

/*
 * Class:     com_example_JniTest
 * Method:    set
 * Signature: (Ljava/lang/String;)Ljava/lang/String;
 */
JNIEXPORT jstring JNICALL Java_com_example_JniTest_set
  (JNIEnv *, jobject, jstring);

#ifdef __cplusplus
}
#endif
#endif
```

从上面我可以看出，函数的命名格式遵循如下规则：`Java_包名_类名_方法名`。比如Demo中的`get`方法，到这里就变成了`JNIEXPORT jstring JNICALL Java_com_example_JniTest_get(JNIEnv *, jobject);`方法。这里面都是JNI标准定义的类型或者宏：
- JNIEnv*：表示一个指向JNI环境的指针，可以通过它访问JNI提供的借口方法
- jobject：表示Java对象中的this
- JNIEXPORT和JNICALL：JNI中所指定的宏，可以在`jni.h`头文件中查找到。

### 2.3 实现JNI方法
JNI方法是指Java中声明的native方法，这里可以选用C++或者C来实现，它们的实现过程是类似的。  
下面分别选用两者来实现JNI方法。首先，在工程的主目录下创建一个子目录，名称随意，这里选择jni作为子目录的名称，然后将之前通过`javah`生成的头文件`com_example_JniTest.h`复制到jni目录下，接着创建`test.cpp`和`test.c`两个文件，它们的实现如下。

```c++
// test.cpp
#include "com_example_JniTest.h"
#include <stdio.h>

/*
 * Class:     com_example_JniTest
 * Method:    get
 * Signature: ()Ljava/lang/String;
 */
JNIEXPORT jstring JNICALL Java_com_example_JniTest_get(JNIEnv *env, jobject thiz) {
  printf("invoke get in c++\n");
  return env->NewStringUTF("Hello from JNI !");
}

/*
 * Class:     com_example_JniTest
 * Method:    set
 * Signature: (Ljava/lang/String;)Ljava/lang/String;
 */
JNIEXPORT jstring JNICALL Java_com_example_JniTest_set(JNIEnv *env, jobject thiz, jstring string) {
  printf("invoke set from c++\n");
  char* str = (char*)env->GetStringUTFChars(string, NULL);
  printf("%s\n", str);
  env->ReleaseStringUTFChars(string, str);
}
```

```c
// test.c
#include "com_example_JniTest.h"
#include <stdio.h>

/*
 * Class:     com_example_JniTest
 * Method:    get
 * Signature: ()Ljava/lang/String;
 */
JNIEXPORT jstring JNICALL Java_com_example_JniTest_get(JNIEnv *env, jobject thiz) {
  printf("invoke get in c\n");
  return (*env)->NewStringUTF(env, "Hello from JNI !");
}

/*
 * Class:     com_example_JniTest
 * Method:    set
 * Signature: (Ljava/lang/String;)Ljava/lang/String;
 */
JNIEXPORT jstring JNICALL Java_com_example_JniTest_set(JNIEnv *env, jobject thiz, jstring string) {
  printf("invoke set from c\n");
  char* str = (char*)(*env)->GetStringUTFChars(env, string, NULL);
  printf("%s\n", str);
  (*env)->ReleaseStringUTFChars(env, string, str);
}
```

### 2.4 编译so库并在Java中调用
编译命令与操作系统相关，此处作者用的是OSX系统。

编译的命令如下：
在jni目录下
```
gcc -I /System/Library/Frameworks/JavaVM.framework/Headers/ -c test.c
gcc -dynamiclib -o libjni-test.jnilib test.o
```
最后会在jni目录下生成`libjni-test.jnilib`文件。

然后在我们的Java文件中加载动态库:
```java
package com.example;

import java.lang.System;

public class JniTest {

  static {
    System.loadLibrary("jni-test");
  }

  public static void main(String[] args) {
    JniTest jniTest = new JniTest();
    System.out.println(jniTest.get());
    jniTest.set("hello world");
  }

  public native String get();
  public native String set(String str);
}
```

最后重新编译Java文件并通过java命令执行：
```
cd ..
javac com/example/JniTest.java
java -Djava.library.path=jni com.example.JniTest
```

![jni执行结果.png]({{ basepath }}/assets/images/jni执行结果.png)

## 3 NDK的开发流程

NDK开发的基本框架官方已经很方便的支持了，查看[Getting Started with the NDK](https://developer.android.com/studio/projects/add-native-code.html#create-sources)
